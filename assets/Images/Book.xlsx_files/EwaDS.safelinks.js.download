(window.dullscriptWebpackJsonp=window.dullscriptWebpackJsonp||[]).push([[37],{1465:function(x,C,b){function a(F){var D=aa.call(this)||this;D.$=F;D.Tb();return D}function c(F){switch(F){case 1:return"Edit";case 2:return"View";case 3:return"InstantView";default:return"Unknown"}}function e(F){switch(F){case 3:return"Word";case 2:return"PowerPoint";case 1:return"Excel";default:return"Unknown"}}function f(F,D,J,R,Z,W){var ka=this;R=void 0===R?!1:R;Z=void 0===Z?null:Z;W=void 0===W?null:W;this.CDa=this.BDa=
0;this.kzb=this.USb=!1;this.Pqa=null;this.wWa=!0;this.vWb=null;n.ULS.sendTraceTag(26019598,378,100,"Initializing SafeLinksManager.");this.vb=F;this.Mg=D;this.JQb=J;f.Dh=W;this.ryg=R?this.vb.Ua("SafeLinksHandlerWebServiceBase"):this.vb.Ua("WebServiceBase");this.ayg=this.vb.Ua("SafeLinksHashedUserId");this.aXj=this.vb.Ua("SafeLinksWorkloadIdHeaderValue");this.rUb=this.vb.Dd("SafeLinksMaxGetPolicyBootRetries",2);this.sUb=this.vb.Dd("SafeLinksMaxGetPolicyOnLinkClickRetries",1);this.ATb=this.isSafeLinksEnabledForUser();
this.zTb=this.Ili();n.ULS.sendTraceTag(26019599,378,50,"SafeLinksManager _isEnabledForUser={0}, _isEnabledForBrowser={1}",this.ATb,this.zTb);if(this.ATb&&this.zTb){D=(F=this.y3a())?F.IsSafeLinksEnabled.toLowerCase():"";J=this.Spd();n.ULS.sendTraceTag(36231312,378,50,"Cached values for IsSafeLinksEnabled: {0}, IsPolicyCookieExpired: {1}.",D,J);var ma=!F||"unknown"===D||F.WasServiceDown||J,pa=B.a.Xr();pa&&(pa.set("shouldGetSafeLinksDataFromServer",ma.toString()),pa.set("isSafeLinksEnabledCacheValue",
D.toString()));this.vb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksLicenseCheck",!1)&&Z?(this.wWa=!1,Z.execute(function(xa){xa.isFeatureEnabled("MsoUrlreputation",!0).then(function(va){ka.wWa=va;pa.set("isUserLicensedForSafeLinks",ka.wWa.toString());E.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",0,"jpittsdirects",pa);ka.wWa&&ma&&ka.hcc(!0);return null})})):(E.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",0,"jpittsdirects",pa),ma&&this.hcc(!0))}}function l(F,D,J,R){this.vb=
F;this.Mg=D;this.dpg=J;l.Dh=R}function m(F,D){this.Hzc=F;this.stopwatch=D}function r(F,D,J,R,Z,W){this.PolicyCookie=this.WebAffinitizedUrl=this.IsSafeLinksEnabled=null;this.PolicyCookieTTL=0;this.WasServiceDown=!1;this.AffinitizedUrl=null;this.IsSafeLinksEnabled=F;this.WebAffinitizedUrl=D;this.PolicyCookie=J;this.PolicyCookieTTL=R;this.WasServiceDown=Z;this.AffinitizedUrl=W}b.r(C);var h=b(11);x=b(0);var w=b(4);C=b(228);var n=b(14),v=b(82);Object(x.a)(r,"SafeLinksData",null,[]);Object(x.a)(m,"SafeLinksGetUrlReputationRequestData",
null,[]);var u=b(41),t=b(39);l.prototype.BBa=function(F,D,J){try{var R=null;l.Dh&&(R=l.Dh.Gc("WebServiceCall","SafeLinksGetUrlReputation"));var Z=new m(D,R);R={};R.AffinitizedUrl=F;R.TargetUrl=D;R.PolicyCookie=J;var W=u.c(R);this.Mg.El(this.dpg,2,W,null,!1,2,Object(v.a)(this,this.RLi,"onGetUrlReputationSuccessCallback"),Object(v.a)(this,this.QLi,"onGetUrlReputationFailureCallback"),Z,void 0,void 0,3E3,3E3,"36");return!0}catch(ka){n.ULS.sendTraceTag(588788033,378,10,ka.message)}return!1};l.prototype.RLi=
function(F){var D="OnGetUrlReputationSuccessCallback: ",J=10,R=F.data.state;try{var Z=u.b(F.data.ke).reputationResults[0],W=Z.navigateUrl.length,ka=R.Hzc.length,ma=Z.navigateUrl===R.Hzc;Z.navigateUrl&&0<Z.navigateUrl.length&&(R.Hzc=Z.navigateUrl);D+=String.format("HttpStatus {0}, verdict {1}, clickedUrlLength = {2} navigateUrlLength {3}, navigateUrlSameAsClickedUrl {4}",F.data.httpStatus,Z.verdict,ka.toString(),W.toString(),ma.toString());J=50}catch(pa){D+=String.format("Exception {0}",pa.message)}this.o5e(R,
D,J)};l.prototype.QLi=function(F){var D="OnGetUrlReputationFailureCallback: ",J=F.data.state;try{D+=String.format("HttpStatus {0}",F.data.httpStatus)}catch(R){D+=String.format("Exception {0}",R.message)}this.o5e(J,D,10)};l.prototype.o5e=function(F,D,J){F.stopwatch&&(F.stopwatch.stop(),F.stopwatch=null);n.ULS.sendTraceTag(588788034,378,J,D);t.a.jf(F.Hzc,void 0,"noopener,noreferrer","SafeLinksNav")};l.Dh=null;Object(x.a)(l,"SafeLinksNavigationHelper",null,[]);var y;(function(F){F[F.enabledByPolicy=
0]="enabledByPolicy";F[F.disabledByPolicy=1]="disabledByPolicy";F[F.disabled_GetPolicyFailure=2]="disabled_GetPolicyFailure";F[F.disabled_PendingGetPolicyRequest=3]="disabled_PendingGetPolicyRequest"})(y||(y={}));Object(x.b)("SafeLinksNavigationState",y);var E=b(100),B=b(134),z=b(1026),M=b(260),Q=b(243),P=b(898),L=b(24),ca=b(176),U=b(356);f.prototype.BBa=function(F){if(!F)return n.ULS.sendTraceTag(593367827,378,10,"SafeLinksManager.TryNavigate: Null/Empty targetUrl"),!1;var D=this.pii(F);n.ULS.sendTraceTag(594830615,
378,50,"SafeLinksManager.TryNavigate: isSupportedHyperLinkType={0},_isEnabledForUser={1},_isEnabledForBrowser={2},_isUserLicensedForSafeLinks={3}",D,this.ATb,this.zTb,this.wWa);if(!(D&&this.ATb&&this.zTb&&this.wWa))return!1;var J=this.Pxj();D=J.state;J=J.returnValue;n.ULS.sendTraceTag(595079385,378,50,"ShouldTryUsingSafeLinksService returned NavigationState={0}",y[D]);var R=B.a.Xr();R&&R.set("SafeLinksNavigationState",y[D]);E.Health.instance.recordKpiUsage("SafeLinksNavigations",0,"jpittsdirects",
R);if(!J)return 2!==D&&3!==D||E.Health.instance.recordKpiFailure("SafeLinksNavigations",y[D],!1,!0,null),!1;n.ULS.sendTraceTag(26019601,378,50,"Using safelinks to navigate hyperlink");if(this.Xxj())return this.Spd()?!1:this.XBi.BBa(this.WHh(),F,this.T0e());if(!this.Spd())return this.bag(F),!0;this.Pqa=F;n.ULS.sendTraceTag(24462627,378,50,"Refreshing the cache as policy cookie expired.");this.kzb=!1;this.hcc();return!0};f.prototype.pii=function(F){F=F.toLowerCase();var D=this.vb.Iw("SafeLinksUnsupportedProtocols");
if(D)for(var J=0;J<D.length;J++)if(F.startsWith(D[J]))return!1;return!0};f.prototype.hcc=function(F){F=void 0===F?!1:F;var D=B.a.Xr();D&&D.set("isOnBootRequest",F.toString());E.Health.instance.recordKpiUsage("SafeLinksGetPolicySuccessfulRequest",1,"jpittsdirects",D);E.Health.instance.recordKpiUsage("SafeLinksGetPolicyFailedRequest",0,"jpittsdirects",D);D=this.k3c("SafeLinksGetPolicy");this.Mg.El(this.hUh,1,null,null,!0,2,Object(v.a)(this,this.yWh,"getSafeLinksDataFromServer_OnSuccessCallback"),Object(v.a)(this,
this.xWh,"getSafeLinksDataFromServer_OnFailureCallback"),D,void 0,void 0,void 0,void 0,"23");this.kzb=F;this.USb=!0;F?this.BDa++:this.CDa++};f.prototype.yWh=function(F){var D=Q.a.YCi,J="";try{this.USb=this.kzb=!1;var R=this.Uyc(F.data.state).returnValue,Z=Object.assign(new U.a,{durationMs:R});E.Health.instance.recordKpiSuccess("SafeLinksGetPolicySuccessfulRequest",Z);n.ULS.sendTraceTag(594830614,378,50,"GetSafeLinksDataFromServer_OnSuccessCallback: HttpStatus {0}, data length {1}, Duration {2}",F.data.httpStatus,
F.data.ke.length,R);if(F.data.httpStatus!==Q.a.kP)J="Unexpected httpStatus: "+F.data.httpStatus.toString();else{R=null;try{R=u.b(F.data.ke)}catch(Ca){J="Exception:"+Ca.toString()+" deserializing response";return}if(R){var W=R.IsSafeLinksEnabled;if(void 0===W||null===W||0>=W.length)J="Invalid isSafeLinksEnabledString";else{n.ULS.sendTraceTag(594830613,378,50,"Retrieved isSafeLinksEnabledString {0}",W);var ka=f.gDd(W);if(void 0===R.WebAffinitizedUrl||null===R.WebAffinitizedUrl||0>=R.WebAffinitizedUrl.length)J=
"Invalid WebAffinitizedUrl";else if(void 0===R.PolicyCookie||null===R.PolicyCookie||0>=R.PolicyCookie.length)J="Invalid PolicyCookie";else if(void 0===R.PolicyCookieTTL||null===R.PolicyCookieTTL)J="Invalid PolicyCookieTTL";else{var ma=R.WebAffinitizedUrl,pa=R.PolicyCookie,xa=R.AffinitizedUrl,va=new Date;va.setMinutes(va.getMinutes()+(5<R.PolicyCookieTTL?R.PolicyCookieTTL-5:0));var ta=va.getTime(),fa=new r(W,ma,pa,ta,!1,xa);this.YXf(fa);D=F.data.httpStatus;this.Pqa&&(ka?(this.bag(this.Pqa),this.CDa=
this.BDa=0):(n.ULS.sendTraceTag(26019602,378,50,"SafeLinks is disabled by admin; Navigating without SafeLinks"),E.Health.instance.recordKpiFailure("SafeLinksNavigations","disabledByPolicy",!0,!0,null),t.a.tV(this.Pqa)),this.Pqa=null)}}}else J="Error when serializing response into SafeLinksData. SafeLinksData is null."}}catch(Ca){J="GetSafeLinksDataFromServer_OnSuccessCallback: Exception:  "+Ca.toString()}finally{D!==Q.a.kP&&this.n5e(D,J)}};f.prototype.xWh=function(F){this.USb=!1;var D=500,J="";try{var R=
this.Uyc(F.data.state).returnValue,Z=Object.assign(new U.a,{durationMs:R});D=F.data.httpStatus;E.Health.instance.recordKpiFailure("SafeLinksGetPolicyFailedRequest","HttpStatusCode_"+D.toString(),!1,!0,Z);J="Request Failed, Status="+P.a[F.data.status]+" Duration: "+R}catch(W){J="GetSafeLinksDataFromServer_OnFailureCallback Exception: "+W.toString()}finally{this.n5e(D,J)}};f.prototype.n5e=function(F,D){D=void 0===D?"":D;try{if(n.ULS.sendTraceTag(594830612,378,10,"HandleGetPolicyRequestError: HttpStatus {0}, Error {1}",
F,D),this.BDa<this.rUb&&this.CDa<this.sUb)this.hcc(this.kzb);else{this.kzb=!1;n.ULS.sendTraceTag(24462656,378,10,"Exhausted all retries for SafeLinks GetPolicy call. OnBootRetries: {0}, OnClickRetries: {1}, HttpStatus: {2}, Error: {3}",this.BDa,this.CDa,F,D);D=null;var J=B.a.Xr();J&&(J.set("HttpStatus",F.toString()),D=Object.assign(new U.a,{extendedProperties:J}));E.Health.instance.recordKpiFailure("SafeLinksGetPolicy1","GetPolicyRequestError",!1,!0,D);var R=new r("false","","",0,!0,"");this.YXf(R);
this.Pqa&&(n.ULS.sendTraceTag(26019603,378,50,"Error occurred during at-click GetPolicy call, NavigationState = {0}","disabled_GetPolicyFailure"),E.Health.instance.recordKpiFailure("SafeLinksNavigations","disabled_GetPolicyFailure",!1,!0,null),t.a.tV(this.Pqa),this.Pqa=null)}}catch(Z){n.ULS.sendTraceTag(594830611,378,10,"HandleGetPolicyRequestError: Exception {0}",Z.toString())}};f.prototype.bag=function(F){var D=this.T0e(),J=this.J_h(),R={};R.Url=F;R.SafeLinksCookie=D;R.CorrelationId=ca.a.create().toString();
R.WorkloadId=this.aXj;R.UserAgentInfo=L.a.DGa+"|"+this.appName;n.ULS.sendTraceTag(23900187,378,50,"Validating hyperlink with request correlation: {0}",R.CorrelationId);t.a.lqc(t.a.NX(4),J,R)};f.prototype.isSafeLinksEnabledForUser=function(){var F=this.vb.Ua("IsSafeLinksEnabledForUser");return F?f.gDd(F):!1};f.prototype.Ili=function(){var F=this.vb.Iw("SafeLinksDisabledBrowsers");if(L.a.XC){if(this.vb.mz("SafeLinksForTeamsIsEnabled")&&this.vb.ra("SafeLinksForTeamsIsEnabled"))return!0;if(Array.contains(F,
"Electron"))return!1}else if(Array.contains(F,L.a.DGa))return!1;return"officecomhwa"===(this.vb.Ua(w.AFrameworkApplication.sea)||"").toLowerCase()?!1:!0};f.prototype.Xxj=function(){return-1!==window.location.href.indexOf("&wd_slnh=1")?!0:L.a.XC};f.prototype.Pxj=function(){var F=0;var D=this.y3a(),J=D?D.IsSafeLinksEnabled:"";if(""!==J)return D.WasServiceDown?(n.ULS.sendTraceTag(51663971,378,50,"Failed to retrieve policy data"),{returnValue:!1,state:2}):"false"===J.toLowerCase()?(n.ULS.sendTraceTag(51664E3,
378,50,"SafeLinks disabled for the user"),{returnValue:!1,state:1}):{returnValue:f.gDd(J),state:F};if(this.USb)return F=3,n.ULS.sendTraceTag(595079384,378,50,"Currently getting SafeLinks policy"),{returnValue:!1,state:F};if(this.BDa>=this.rUb||this.CDa>=this.sUb)return F=2,n.ULS.sendTraceTag(51664001,378,50,"Exhausted all retries- Failure in GetPolicy for SafeLinks ({0}/{1} boot, {2}/{3} onClick)",this.BDa,this.rUb,this.CDa,this.sUb),{returnValue:!1,state:F};n.ULS.sendTraceTag(23900182,378,10,"Inconsistent SafeLinks state: SafeLinks cache data is null with no on boot request pending, and {0} retries left over. Perhaps LocalStorage is inaccessable.",
this.rUb+this.sUb-(this.BDa+this.CDa));return{returnValue:!0,state:F}};f.prototype.T0e=function(){var F=this.y3a();return F?F.PolicyCookie:""};f.prototype.J_h=function(){var F=this.y3a();return F?F.WebAffinitizedUrl:""};f.prototype.WHh=function(){var F=this.y3a();return F?F.AffinitizedUrl:""};f.prototype.ZNh=function(){var F=new Date;try{var D=this.y3a();F.setTime(D?D.PolicyCookieTTL:0)}catch(J){n.ULS.sendTraceTag(24462658,378,10,"Exception occured while fetching expiration time from cache: {0}",
J)}return F};f.prototype.Spd=function(){var F=this.ZNh();return!!F&&F.getTime()<Date.now()};f.prototype.y3a=function(){if(!this.vWb){var F=z.a.instance.getItem(this.userId);if(!F||""===F)return null;this.vWb=JSON.parse(F)}return this.vWb};f.prototype.YXf=function(F){if(void 0===F||null===F)throw Error.argumentNull("safeLinksData");if(void 0===F.IsSafeLinksEnabled||null===F.IsSafeLinksEnabled||0>=F.IsSafeLinksEnabled.length)throw Error.argumentNull("safeLinksData.IsSafeLinksEnabled");this.vWb=F;F.WasServiceDown||
this.iXj(F)};f.prototype.iXj=function(F){F=JSON.stringify(F);z.a.instance.setItem(this.userId,F)};f.prototype.k3c=function(F){return void 0!==f.Dh&&null!==f.Dh?f.Dh.Gc("WebServiceCall",F):null};f.prototype.Uyc=function(F){if(void 0!==F&&null!==F){var D=F.Bc;F.stop();return{returnValue:D,stopwatch:null}}return{returnValue:null,stopwatch:F}};f.gDd=function(F){return"false"!==F.toLowerCase()?!0:!1};Ek.Object.defineProperties(f.prototype,{appName:{configurable:!0,enumerable:!0,get:function(){return this.JQb}},
jDc:{configurable:!0,enumerable:!0,get:function(){return this.ryg}},userId:{configurable:!0,enumerable:!0,get:function(){return this.ayg}},hUh:{configurable:!0,enumerable:!0,get:function(){var F=this.jDc?this.jDc+"/":"",D=new M.QueryStringBuilder("SafeLinksHandler.ashx");D.Xi("app",this.appName);this.vb.ra("SafeLinksUseDebugHeader")&&D.Xi("action","debug");this.vb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",!1)&&D.Xi("s2satpop","1");this.vb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAAT",
!1)&&D.Xi("s2saat","1");this.vb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&D.Xi("s2se03","1");return String.format("{0}{1}&{2}",F,D.toString(),w.AFrameworkApplication.oj)}},XZh:{configurable:!0,enumerable:!0,get:function(){var F=this.jDc?this.jDc+"/":"",D=new M.QueryStringBuilder("SafeLinksHandler.ashx");D.Xi("app",this.appName);this.vb.ra("SafeLinksUseDebugHeader")&&D.Xi("action","debug");this.vb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",
!1)&&D.Xi("s2satpop","1");this.vb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAAT",!1)&&D.Xi("s2saat","1");this.vb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&D.Xi("s2se03","1");D.Xi("slrt","GetUrlReputation");return String.format("{0}{1}&{2}",F,D.toString(),w.AFrameworkApplication.oj)}},XBi:{configurable:!0,enumerable:!0,get:function(){f.wQc||(f.wQc=new l(this.vb,this.Mg,this.XZh,f.Dh));return f.wQc}}});f.Dh=null;f.wQc=null;Object(x.a)(f,
"SafeLinksManager",null,[909]);var aa=C.a;Am(a,aa);a.prototype.create=function(){this.Eb(this.$.da.Aa(269)||new f(w.AFrameworkApplication.ga,w.AFrameworkApplication.Jd,String.format("{0}-{1}",e(w.AFrameworkApplication.ta.Qa.Sj),c(w.AFrameworkApplication.ta.Qa.qca))))};a.ka=function(F){F.da.Ga(270,new a(F))};Object(x.a)(a,"SafeLinksManagerFactory",C.a,[]);Type.registerNamespace("_Ewa");Type.registerNamespace("Common.App.SafeLinks");(function(){h.a.Fa(function(F){a.ka(F)})})()}}]);

//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/EwaDS.safelinks.js.map/e612f4fe77b9888d059bd3a277ab94ac/EwaDS.safelinks.js.map